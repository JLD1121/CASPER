<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot - Cajas Personalizadas</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de Font Awesome para el √≠cono de chat -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        /* Definici√≥n de la fuente Inter y el esquema de color */
        body { font-family: 'Inter', sans-serif; }
        
        /* Estilos personalizados para el contenedor del chat */
        #chat-window {
            z-index: 1000;
            right: 1.5rem;
            bottom: 6rem; /* Espacio para el bot√≥n flotante */
            max-width: 400px;
            height: 500px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            transform: scale(0.8);
            transform-origin: bottom right;
            opacity: 0;
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        }

        #chat-window.open {
            transform: scale(1);
            opacity: 1;
        }

        /* Estilo para el bot√≥n flotante de chat (color cafe claro: #D2B48C) */
        #chat-button {
            z-index: 1010;
            right: 1.5rem;
            bottom: 1.5rem;
            background-color: #D2B48C; /* Caf√© claro */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
            transition: background-color 0.2s;
        }
        #chat-button:hover {
            background-color: #C3A378; /* Un poco m√°s oscuro al pasar el rat√≥n */
        }
        
        /* Estilos para los mensajes */
        .message-bot {
            background-color: #f7f7f7;
            border-radius: 12px 12px 12px 0;
        }
        .message-user {
            background-color: #D2B48C; /* El mismo color del bot√≥n para el usuario */
            color: #444;
            border-radius: 12px 12px 0 12px;
        }
        
        /* Estilo para la barra de desplazamiento */
        #chat-messages::-webkit-scrollbar {
            width: 6px;
        }
        #chat-messages::-webkit-scrollbar-thumb {
            background-color: #c9c9c9;
            border-radius: 3px;
        }

        /* Adaptabilidad m√≥vil */
        @media (max-width: 640px) {
            #chat-window {
                right: 0.5rem;
                left: 0.5rem;
                bottom: 5rem;
                max-width: unset;
                height: 80vh;
            }
            #chat-button {
                right: 0.5rem;
                bottom: 0.5rem;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4">

    <!-- Contenido de Ejemplo para dar contexto -->
    <div class="max-w-4xl mx-auto bg-white p-8 rounded-xl shadow-lg">
        <h1 class="text-4xl font-extrabold text-stone-800 mb-4">Servicio al Cliente: Cajas Personalizadas Casper</h1>
        <p class="text-stone-600 mb-6">
            ¬°Bienvenido a nuestro portal de atenci√≥n! Aqu√≠ puedes encontrar toda la informaci√≥n sobre nuestros productos, materiales, precios y proceso de compra.
            Si tienes alguna duda r√°pida, usa el icono de chat en la esquina inferior derecha para hablar con nuestro bot, Casper.
        </p>
        <div class="space-y-4">
            <div class="p-4 bg-stone-100 rounded-lg">
                <h3 class="font-bold text-stone-700">Materiales Premium</h3>
                <p class="text-sm text-stone-500">Cart√≥n r√≠gido, microcorrugado y kraft ecol√≥gico.</p>
            </div>
            <div class="p-4 bg-stone-100 rounded-lg">
                <h3 class="font-bold text-stone-700">Estilos Exclusivos</h3>
                <p class="text-sm text-stone-500">Tapa magn√©tica, deslizables, tipo cofre y con ventana.</p>
            </div>
        </div>
    </div>
    
    <!-- üí¨ Ventana del Chatbot (Oculta por defecto) -->
    <div id="chat-window" class="fixed flex flex-col bg-white rounded-xl overflow-hidden shadow-2xl hidden">
        
        <!-- Encabezado del Chat -->
        <div class="p-4 bg-stone-700 text-white flex justify-between items-center rounded-t-xl">
            <div class="flex items-center">
                <i class="fas fa-robot mr-2"></i>
                <h2 class="font-semibold">Chatbot Casper</h2>
            </div>
            <button onclick="toggleChat()" class="text-white hover:text-gray-300">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <!-- √Årea de Mensajes -->
        <div id="chat-messages" class="flex-grow p-4 space-y-4 overflow-y-auto">
            <!-- Los mensajes se insertar√°n aqu√≠ por JS -->
        </div>

        <!-- √Årea de Input -->
        <div class="p-4 border-t border-gray-200">
            <div class="flex items-center">
                <input type="text" id="user-input" placeholder="Escribe tu pregunta..."
                       class="flex-grow p-3 border border-gray-300 rounded-l-lg focus:outline-none focus:border-stone-500"
                       onkeypress="if(event.key === 'Enter') sendMessage()">
                <button onclick="sendMessage()"
                        class="bg-stone-500 hover:bg-stone-600 text-white p-3 rounded-r-lg transition duration-150">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>
    
    <!-- üñºÔ∏è Bot√≥n Flotante de Chat (Cafe Claro) -->
    <button id="chat-button" onclick="toggleChat()"
            class="fixed w-16 h-16 rounded-full flex items-center justify-center text-white text-3xl cursor-pointer">
        <i class="fas fa-comments"></i>
    </button>
    

    <script>
        // üìö Base de conocimiento
        const baseConocimiento = {
            "producto": {
                "¬øqu√© productos ofrecen?": "Ofrecemos cajas personalizadas en cart√≥n r√≠gido, microcorrugado y kraft ecol√≥gico.",
                "¬øqu√© estilos de cajas tienen?": "Tenemos estilos como tapa magn√©tica, deslizables, tipo cofre y con ventana transparente."
            },
            "precio": {
                "¬øcu√°nto cuestan las cajas?": "El precio depende del tama√±o, material y cantidad.",
                "¬øel precio var√≠a seg√∫n la cantidad?": "Si, Tambi√©n seg√∫n el material pero el precio minimo es de $20.000."
            },
            "c√≥mo comprar": {
                "¬øc√≥mo puedo comprar?": "1. Elige el tipo de caja y personalizaci√≥n. 2. Haz tu pedido con las cantidades deseadas. 3. Confirmamos dise√±o y te damos el tiempo de entrega."
            },
            "contacto": {
                "¬øc√≥mo puedo contactarlos?": "Puedes escribirnos a: cajas.personalizadas@gmail.com O llamarnos al: +57 300 123 4567"
            }
        };

        // ü§ù Respuestas r√°pidas
        const respuestasSaludo = [
            "¬°Hola! üòä Soy tu chatbot Casper. ¬øEn qu√© te puedo ayudar?",
            "¬°Buenos d√≠as! üåü Puedo responder sobre cualquier duda respecto a las cajas personalizadas.",
            "¬°Hola! üëã ¬øQu√© te gustar√≠a saber hoy?"
        ];

        const respuestasDespedida = [
            "¬°Hasta pronto! üëã Espero haber aclarado tus dudas.",
            "¬°Nos vemos! üòä",
            "¬°Adi√≥s! üåü Que tengas un gran d√≠a."
        ];
        
        // --- Elementos del DOM ---
        const chatWindow = document.getElementById('chat-window');
        const chatMessages = document.getElementById('chat-messages');
        const userInput = document.getElementById('user-input');

        // --- Funciones de Utilidad ---

        /**
         * üßπ Limpia y normaliza el texto.
         * @param {string} texto - El texto de entrada.
         * @returns {string} Texto limpio en min√∫sculas.
         */
        function limpiarTexto(texto) {
            if (typeof texto !== 'string') return '';
            texto = texto.toLowerCase();
            // Elimina caracteres especiales, pero mantiene '¬ø', '?', '√°√©√≠√≥√∫√±' y espacios.
            texto = texto.replace(/[^\w\s¬ø?√°√©√≠√≥√∫√±]/g, ' ');
            // Elimina m√∫ltiples espacios y recorta
            return texto.trim().split(/\s+/).join(' ');
        }
        
        /**
         * üéØ Calcula la similitud de Jaccard entre dos textos (basado en palabras).
         * @param {string} textoA - Texto del usuario.
         * @param {string} textoB - Pregunta de la base de conocimiento.
         * @returns {number} Puntuaci√≥n de similitud (0 a 1).
         */
        function calcularSimilitud(textoA, textoB) {
            const cleanA = limpiarTexto(textoA);
            const cleanB = limpiarTexto(textoB);
            
            const wordsA = new Set(cleanA.split(' ').filter(w => w.length > 1));
            const wordsB = new Set(cleanB.split(' ').filter(w => w.length > 1));

            if (wordsA.size === 0 || wordsB.size === 0) return 0;

            const intersectionSize = [...wordsA].filter(x => wordsB.has(x)).length;
            const unionSize = wordsA.size + wordsB.size - intersectionSize;

            return intersectionSize / unionSize;
        }

        /**
         * üí¨ Crea y a√±ade un mensaje a la interfaz de chat.
         * @param {string} texto - El contenido del mensaje.
         * @param {string} tipo - 'bot' o 'user'.
         */
        function addMessage(texto, tipo) {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `flex ${tipo === 'user' ? 'justify-end' : 'justify-start'}`;

            const messageBubble = document.createElement('div');
            messageBubble.className = `max-w-xs md:max-w-sm p-3 rounded-xl shadow-md text-sm ${
                tipo === 'user' ? 'message-user' : 'message-bot'
            }`;
            messageBubble.innerHTML = texto.replace(/\n/g, '<br>'); // Respeta saltos de l√≠nea

            messageWrapper.appendChild(messageBubble);
            chatMessages.appendChild(messageWrapper);

            // Desplazar hacia abajo para ver el nuevo mensaje
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        /**
         * üöÄ L√≥gica principal del chatbot para encontrar la mejor respuesta.
         * @param {string} preguntaUsuario - La pregunta del usuario.
         * @returns {string} La mejor respuesta encontrada.
         */
        function encontrarMejorRespuesta(preguntaUsuario) {
            const preguntaLimpia = limpiarTexto(preguntaUsuario);
            
            // Detecci√≥n de saludos y despedidas
            const saludos = ['hola', 'buenos d√≠as', 'saludos', 'qu√© tal', 'hey'];
            if (saludos.some(s => preguntaLimpia.includes(s))) {
                return respuestasSaludo[Math.floor(Math.random() * respuestasSaludo.length)];
            }

            const despedidas = ['adi√≥s', 'hasta luego', 'nos vemos', 'chau', 'bye', 'salir', 'terminar'];
            if (despedidas.some(d => preguntaLimpia.includes(d))) {
                return respuestasDespedida[Math.floor(Math.random() * respuestasDespedida.length)];
            }

            let mejorRespuesta = "";
            let mejorPuntuacion = 0;
            let materiaEncontrada = "";

            for (const materia in baseConocimiento) {
                const preguntas = baseConocimiento[materia];
                for (const preguntaBase in preguntas) {
                    const puntuacion = calcularSimilitud(preguntaLimpia, limpiarTexto(preguntaBase));
                    
                    if (puntuacion > mejorPuntuacion) {
                        mejorPuntuacion = puntuacion;
                        mejorRespuesta = preguntas[preguntaBase];
                        materiaEncontrada = materia;
                    }
                }
            }

            const umbralMinimo = 0.15; // Un umbral m√°s bajo para la similitud Jaccard
            
            if (mejorPuntuacion > umbralMinimo) {
                const materiaCapitalizada = materiaEncontrada.charAt(0).toUpperCase() + materiaEncontrada.slice(1);
                return `üìö [${materiaCapitalizada}] ${mejorRespuesta}`;
            } else {
                return [
                    "ü§î No estoy seguro, ¬øpuedes reformular la pregunta?",
                    "‚ùì Hmm, no tengo esa informaci√≥n. Intenta con preguntas m√°s directas como '¬øQu√© productos ofrecen?' o '¬øC√≥mo puedo comprar?'."
                ][Math.floor(Math.random() * 2)];
            }
        }

        /**
         * üì© Maneja el env√≠o de mensajes por el usuario.
         */
        function sendMessage() {
            const userText = userInput.value.trim();
            if (userText === '') return;

            // 1. Mostrar mensaje del usuario
            addMessage(userText, 'user');
            userInput.value = '';
            
            // 2. Obtener respuesta del bot (simulaci√≥n de tiempo de respuesta)
            setTimeout(() => {
                const botResponse = encontrarMejorRespuesta(userText);
                addMessage(botResponse, 'bot');
            }, 500);
        }
        
        /**
         * üîÑ Muestra u oculta la ventana del chat.
         */
        function toggleChat() {
            chatWindow.classList.toggle('hidden');
            // Usamos clases de Tailwind y CSS para la animaci√≥n
            setTimeout(() => {
                chatWindow.classList.toggle('open');
            }, 10); // Un peque√±o retraso para asegurar la animaci√≥n

            if (chatWindow.classList.contains('open')) {
                // Al abrir, forzar un saludo y enfoque
                userInput.focus();
                if (chatMessages.children.length === 0) {
                    setTimeout(() => {
                        addMessage(respuestasSaludo[0], 'bot');
                    }, 500);
                }
            }
        }

        // --- Inicializaci√≥n ---
        window.onload = function() {
            // Eliminar la clase 'hidden' despu√©s de la carga para que la transici√≥n funcione la primera vez que se abre.
            // La visibilidad inicial se controla solo por CSS/JS al hacer click.
            // Para mantenerlo cerrado por defecto, lo dejaremos como est√°, con el `hidden` inicial.
        };

    </script>
</body>
</html>

